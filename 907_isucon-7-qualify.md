# ISUCON 7 qualify


特に、GET /fetch はスコアがなく、GET /messageには受信メッセージ数にも加算されるというところがポイントでした。

クライアントはGET /fetchをポーリングしていて、閲覧中のチャンネルに新着メッセージがある場合にはGET /messageを呼んで新着メッセージを受信します。GET /fetchのレスポンスをどんなに改善しても、新着メッセージがなければスコアは上がりません。閲覧中のチャンネルに新着メッセージが1件ある状態ですぐに返しても、GET /messageで1点とそこに含まれる1メッセージ分の1点で、2リクエストで2点しか稼ぐことができません。

しかしGET /fetchをタイムアウトにならない範囲で遅くしてやると、GET /messageは1リクエストで数十件のメッセージを取得することができるので2リクエストで数十点を稼ぐ事ができます。

このようにリアルタイム性のあるアプリケーションでは、要求される時間内でイベントをバッチ化することでスループットが上がっても比例して負荷が上がらないように設計できることがあります。

GET /fetchとGET /messageは N+1 クエリや COUNT クエリなど非常に重い処理になっていたのでどのチームもこの処理を軽くすることに力を入れたと思いますが、単に処理を軽くするだけでなく一見無駄に見える参照実装の sleep の意味に気づくとブレイクスルーすることができたと思います。

https://github.com/isucon/isucon7-qualify/blob/master/webapp/go/src/isubata/app.go#L445
